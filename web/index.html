<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOBN - Camera Control Arcade</title>
    <link rel="stylesheet" href="arcade.css">
</head>
<body>
    <div class="arcade-cabinet">
        <!-- Main Game Area -->
        <div class="main-game-area">
            <!-- Cabinet Header with Title -->
            <div class="cabinet-header">
                <div class="neon-title">
                    <h1 class="game-title">BOBN</h1>
                    <p class="subtitle">SPACE DEFENDER</p>
                </div>
            </div>

            <!-- Main Game Screen Area -->
            <div class="screen-bezel">
                <div class="crt-container">
                    <canvas id="gameCanvas" width="800" height="500" class="game-screen"></canvas>
                    <div class="crt-overlay"></div>
                    <div class="scanlines"></div>
                    <div class="screen-glow"></div>
                </div>
            </div>

            <!-- Status Messages -->
            <div class="status-section">
                <div id="loadingMessage" class="status-message loading">
                    INITIALIZING SYSTEM...
                </div>
                <div id="errorMessage" class="status-message error" style="display: none;"></div>
                <div id="gameMessage" class="status-message game-status" style="display: none;">
                    PRESS START TO PLAY
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="side-panel">
            <!-- Stats Panel -->
            <div class="stats-panel">
                <div class="stat-display">
                    <div class="stat-label">SCORE</div>
                    <div id="score" class="stat-value">000000</div>
                </div>
                <div class="stat-display">
                    <div class="stat-label">HIGH</div>
                    <div id="highScore" class="stat-value">000000</div>
                </div>
                <div class="stat-display">
                    <div class="stat-label">LIVES</div>
                    <div id="lives" class="stat-value">3</div>
                </div>
                <div class="stat-display">
                    <div class="stat-label">LEVEL</div>
                    <div id="level" class="stat-value">1</div>
                </div>
            </div>

            <!-- Oscilloscope -->
            <div class="oscilloscope-section">
                <div class="oscilloscope-label">HEAD TRACKING</div>
                <div class="oscilloscope-bezel">
                    <canvas id="oscilloscope" width="240" height="120" class="oscilloscope-screen"></canvas>
                    <div class="oscilloscope-overlay"></div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="coin-slot-section">
                    <button id="startBtn" class="arcade-button start-button">
                        <div class="button-top"></div>
                        <span>START<br/>GAME</span>
                    </button>
                </div>

                <!-- Sensitivity Control -->
                <div class="sensitivity-control">
                    <div class="sensitivity-label">TRACKING SENSITIVITY</div>
                    <div class="sensitivity-slider-container">
                        <span class="slider-label">LOW</span>
                        <input type="range" id="sensitivitySlider" class="sensitivity-slider"
                               min="1" max="10" value="4" step="0.5">
                        <span class="slider-label">HIGH</span>
                    </div>
                    <div class="sensitivity-value" id="sensitivityValue">4.0x</div>
                </div>

                <div class="instruction-panel">
                    <div class="instructions-title">CONTROLS</div>
                    <div class="control-item">SPACEBAR - FIRE</div>
                    <div class="control-item">ARROWS - MOVE</div>
                    <div class="control-item">ENTER - START</div>
                    <div class="control-item">ESC - PAUSE</div>
                    <div class="control-item">CAMERA - HEAD CONTROL</div>
                </div>
            </div>
        </div>

        <!-- Retro Background Effects -->
        <div class="background-effects">
            <div class="grid-overlay"></div>
            <div class="neon-glow-bg"></div>
        </div>
    </div>

    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        let gameInitialized = false;

        // Game state elements
        const elements = {
            loadingMessage: document.getElementById('loadingMessage'),
            errorMessage: document.getElementById('errorMessage'),
            gameMessage: document.getElementById('gameMessage'),
            scoreDisplay: document.getElementById('score'),
            highScoreDisplay: document.getElementById('highScore'),
            livesDisplay: document.getElementById('lives'),
            levelDisplay: document.getElementById('level'),
            startBtn: document.getElementById('startBtn'),
            oscilloscope: document.getElementById('oscilloscope')
        };

        // Initialize oscilloscope (placeholder - actual display handled by camera controller)
        function initOscilloscope() {
            const ctx = elements.oscilloscope.getContext('2d');

            // Initial black background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 240, 120);

            // Show initial "NO SIGNAL" message
            ctx.font = '16px monospace';
            ctx.fillStyle = '#00ff00';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('NO SIGNAL', 120, 60);
        }

        // Sensitivity slider functionality
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityValue = document.getElementById('sensitivityValue');

        // Store sensitivity globally for the WASM module to access
        window.cameraSensitivity = parseFloat(sensitivitySlider.value);

        sensitivitySlider.addEventListener('input', function() {
            const value = parseFloat(this.value);
            window.cameraSensitivity = value;
            sensitivityValue.textContent = value.toFixed(1) + 'x';

            // Store in localStorage
            localStorage.setItem('headTrackingSensitivity', value.toString());
        });

        // Load saved sensitivity
        const savedSensitivity = localStorage.getItem('headTrackingSensitivity');
        if (savedSensitivity) {
            const value = parseFloat(savedSensitivity);
            sensitivitySlider.value = value;
            window.cameraSensitivity = value;
            sensitivityValue.textContent = value.toFixed(1) + 'x';
        }

        // Start button functionality
        elements.startBtn.addEventListener('click', function() {
            if (gameInitialized) {
                // Visual feedback
                this.style.transform = 'translateY(2px)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 100);

                elements.gameMessage.textContent = 'GAME STARTING...';

                // Simulate Enter key press to start game
                const enterEvent = new KeyboardEvent('keydown', {
                    key: 'Enter',
                    code: 'Enter',
                    keyCode: 13
                });
                document.dispatchEvent(enterEvent);
            }
        });

        async function loadWasm() {
            try {
                elements.loadingMessage.textContent = 'LOADING WASM MODULE...';

                const result = await WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject);

                elements.loadingMessage.textContent = 'WASM MODULE LOADED! INITIALIZING...';

                go.run(result.instance);

                // Game initialization complete
                gameInitialized = true;
                elements.loadingMessage.style.display = 'none';
                elements.gameMessage.style.display = 'block';
                elements.gameMessage.textContent = 'PRESS START TO PLAY';

            } catch (err) {
                console.error('Failed to load WASM:', err);
                elements.loadingMessage.style.display = 'none';
                elements.errorMessage.style.display = 'block';
                elements.errorMessage.textContent = 'SYSTEM ERROR: ' + err.message;
            }
        }

        // Initialize when ready
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            initOscilloscope();
            loadWasm();
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                initOscilloscope();
                loadWasm();
            });
        }
    </script>
</body>
</html>